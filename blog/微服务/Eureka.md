**1.Eureka(处于集群配置)原理：**

- -处于不同节点的Eureka通过Replicate进行数据同步
- -Application Service为服务提供者
- -Application Client为服务消费者
- -Make remote Call完成一次服务调用

服务启动向Eureka注册，Eureka Server会将注册信息向其他Eureka Server进行同步，当服务消费者要调用服务提供者，则向服务注册中心获取服务提供者地址，然后将服务提供者地址缓存在本地，下次再调用，直接从本地缓存中取，完成依次调用。

当服务注册中心Eureka Server检测到服务提供者因为宕机，网络原因不可用，则在服务注册中心将服务置为Down状态，并把当前服务提供者状态向订阅者发布，订阅过的服务消费者更新本地缓存

服务启动，周期性（30秒）向Eureka Server发送心跳，以证明服务是可用状态。Eureka Server在（默认90s）未收到客户端的心跳，则认为服务宕机，注销该实例。



**2.Eureka自我保护机制**

默认90s没有得到客户端的心跳，则注销该实例，但是往往因为微服务跨进程调用，网络通信面临着各种问题，比如服务政策，网络分区故障，Eureka Server注销服务实例则会让大部分服务不可用，这样很危险，因为服务没问题

自我保护机制的原理：Eureka Server在短时间内丢失过多的客户端（可能发生网络故障），那么这个节点将进入自我保护模式，不在注销任务服务，当网络故障护肤师，改节点会自动退出自我保护模式。

配置自我保护模式开启：eureka.server.enable‐self‐preservation=true  

目的：防止错杀服务，当个别客户端出现心跳失联时，则认为是客户端的问题，剔除掉客户端；当 Eureka 捕获到大量的心跳失败时，则认为可能是网络问题，进入自我保护机制；当客户端心跳恢复时，Eureka 会自动退出自我保护机制  

3.Eureka保证的是高可用性和分区容错性（AP），Zookeeper保证的是cp



**4,Eureka如何保证的AP**

Eureka各个节点都是平等的，几个节点挂掉不会影响正常节点的工作，剩余的节点依然可以提供注
册和查询服务。而Eureka的客户端在向某个Eureka注册或时如果发现连接失败，则会自动切换至其它节点，只要有一台Eureka还在，就能保证注册服务可用(保证可用性)，只不过查到的信息可能不是最新的(不保证强一致性)。

Eureka还有一种自我保护机制，如果在15分钟内超过85%的节点都没有正常的心跳，那么Eureka就认为客户端与注册中心出现了网络故障，此时会出现以下几种情况：

Eureka不再从注册列表中移除因为长时间没收到心跳而应该过期的服务

Eureka仍然能够接受新服务的注册和查询请求，但是不会被同步到其它节点上(即保证当前节点依然可用)

当网络稳定时，当前实例新的注册信息会被同步到其它节点中因此， Eureka可以很好的应对因网络故障导致部分节点失去联系的情况，而不会像zookeeper那样使整个注册服务瘫痪。  



总结：注册中心注重的是可用行，所以Eureka比zookeeeper更专业



**5.Eureka工作流程**
1、Eureka Server 启动成功，等待服务端注册。在启动过程中如果配置了集群，集群之间定时通过 Replicate 同步注册表，每个 Eureka Server 都存在独立完整的服务注册表信息
2、Eureka Client 启动时根据配置的 Eureka Server 地址去注册中心注册服务
3、Eureka Client 会每 30s 向 Eureka Server 发送一次心跳请求，证明客户端服务正常
4、当 Eureka Server 90s 内没有收到 Eureka Client 的心跳，注册中心则认为该节点失效，会注销该实例
5、单位时间内 Eureka Server 统计到有大量的 Eureka Client 没有上送心跳，则认为可能为网络异常，进入自我保护机制，不再剔除没有上送心跳的客户端
6、当 Eureka Client 心跳请求恢复正常之后，Eureka Server 自动退出自我保护模式
7、Eureka Client 定时全量或者增量从注册中心获取服务注册表，并且将获取到的信息缓存到本地
8、服务调用时，Eureka Client 会先从本地缓存找寻调取的服务。如果获取不到，先从注册中心刷新注册表，再同步到本地缓存
9、Eureka Client 获取到目标服务器信息，发起服务调用
10、Eureka Client 程序关闭时向 Eureka Server 发送取消请求，Eureka Server 将实例从注册表中删除  