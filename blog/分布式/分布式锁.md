                                                       分布式锁

1.使用场景

- 多台机器执行同一个定时任务，不能重复执行，只能允许一台机器执行
- 秒杀场景，只允许某一个用户抢到

2.分布式锁实现的方式

- 基于数据库实现分布式锁（使用行锁或者表锁）
- 基于缓存实现（Redis）
- 基于Zookeeper

3.分布式锁的特征

- 互斥性（部署的集群中只允许一台机器的一个线程执行）来保证一致性
- 可重入锁（避免死锁）

4.分布式锁的实现

4.1Redis分布式锁（单机版）

Redis提供了setnx(set if not exists)指令+lua脚本实现

4.2 setnx实现原理：

通过setnx设置key-value,value要具有唯一性，set命令要用set key value px milliseconds nx  ；来获得锁，随即进入死循环，来判断key是否存在，存在则继续循环，不存在key则跳出循环。任务执行完毕，删除key。



**注意事项**：

- 释放锁时要验证value值，防止误删锁
- value具有唯一性
- 定期刷新过期时间，以保障大于业务时间



4.4为什么适合单机版





ZK锁和Redis锁的优缺点：

Redis锁：

Redis只保证最终一致性，副本之间的数据复制是异步进行的（Redis集群一般是读写分离架构，存在主从同步延迟情况），主从切换会可能会有些数据没有复制过去，可能会**有丢失锁的情况**，所以强一致性的业务要求不推荐使用Redis锁，推荐ZK锁

